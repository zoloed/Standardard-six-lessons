<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Decimal Subtraction</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Source+Code+Pro:wght@400;600&family=Patrick+Hand&display=swap" rel="stylesheet">
    <!-- Canvas Confetti for celebrations -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <!-- Tone.js for sound effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('https://images.unsplash.com/photo-1577896851231-70ef18881754?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .main-container {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        .calculation-font {
            font-family: 'Source Code Pro', monospace;
        }
        #highlight-box {
            position: absolute;
            border: 2px solid #fbbf24; /* amber-400 */
            border-radius: 0.375rem; /* rounded-md */
            background-color: rgba(251, 191, 36, 0.1);
            transition: all 0.3s ease-in-out;
            pointer-events: none;
        }
        .calc-cell {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 2.5rem; 
            height: 4rem;
            font-size: 2.25rem; 
            box-sizing: border-box; 
            position: relative;
        }
        .borrow-digit {
            position: absolute;
            color: #ef4444; /* red-500 */
            text-decoration: line-through;
            text-decoration-thickness: 2px;
        }
        .borrow-new-digit {
            position: absolute;
            top: -0.25rem;
            color: #f59e0b; /* amber-500 */
        }
        .borrow-one {
            position: absolute;
            top: 0.5rem;
            left: -0.25rem;
            font-size: 1.5rem;
            color: #f59e0b; /* amber-500 */
        }
        .practice-input {
            text-align: center;
            border: 2px solid #d1d5db;
            border-radius: 0.25rem;
            background-color: #f9fafb;
            transition: all 0.2s;
        }
        .input-correct {
            border-color: #10b981 !important;
            color: #059669 !important;
            background-color: #d1fae5 !important;
        }
        .input-incorrect {
            border-color: #ef4444 !important;
            color: #dc2626 !important;
            background-color: #fee2e2 !important;
        }
        .chalkboard-font {
            font-family: 'Patrick Hand', cursive;
        }
        .horizontal-problem {
            font-size: 2.25rem;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-6xl p-6 sm:p-8 space-y-6 rounded-xl shadow-2xl main-container">
        
        <!-- Mode Selection -->
        <div id="mode-selection">
            <div class="text-center">
                <h1 class="text-4xl font-bold text-gray-800">Interactive Decimal Subtraction</h1>
                <p class="mt-2 text-xl text-gray-600">Choose a mode to get started!</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-12">
                <button id="learnModeBtn" class="py-6 px-4 rounded-lg text-white bg-blue-500 hover:bg-blue-600 text-2xl font-bold shadow-lg transition transform hover:-translate-y-1">Learn Step-by-Step</button>
                <button id="practiceModeBtn" class="py-6 px-4 rounded-lg text-white bg-green-500 hover:bg-green-600 text-2xl font-bold shadow-lg transition transform hover:-translate-y-1">Practice Yourself</button>
            </div>
        </div>

        <!-- Input View -->
        <div id="input-view" class="hidden">
             <div class="text-center">
                <h1 id="input-title" class="text-3xl font-bold text-gray-800"></h1>
            </div>
            <div class="space-y-4 mt-6">
                <div>
                    <label for="number1" class="text-sm font-medium text-gray-700">First Number (Minuend)</label>
                    <input type="number" id="number1" step="0.001" placeholder="e.g., 123.45" class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg text-gray-900 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="number2" class="text-sm font-medium text-gray-700">Second Number (Subtrahend)</label>
                    <input type="number" id="number2" step="0.001" placeholder="e.g., 67.89" class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg text-gray-900 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </div>
             <p id="input-error" class="text-sm text-red-600 mt-4 text-center h-5"></p>
            <div class="mt-2 flex space-x-4">
                 <button id="backToModesBtn" class="w-1/3 flex justify-center py-3 px-4 border rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300">Back</button>
                <button id="startBtn" class="w-2/3 flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Let's Go!</button>
            </div>
        </div>

        <!-- Calculation View -->
        <div id="calculation-view" class="hidden">
             <div class="bg-gray-800 p-4 rounded-lg calculation-font text-white shadow-inner flex justify-between items-center" style="background-color: #3a5a40;">
                <div class="pr-4 horizontal-problem">
                    <span id="h-problem-text"></span>
                    <span id="h-problem-answer" class="text-yellow-300 font-bold"></span>
                </div>
                <div id="calculation-area" class="relative flex flex-col items-end">
                    <div id="highlight-box" class="hidden"></div>
                    <div id="num1-row"></div>
                    <div id="num2-row"></div>
                    <hr class="border-gray-400 my-2 w-full">
                    <div id="result-row"></div>
                </div>
            </div>
            <div id="explanation-box" class="mt-4 p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded-r-lg">
                <p id="explanation" class="text-gray-800 text-xl"></p>
            </div>
             <div id="feedback-box" class="hidden mt-4 p-3 rounded-lg text-center h-20 flex items-center justify-center transition-all duration-300 chalkboard-font text-3xl">
                 <p id="feedback-text"></p>
            </div>
            <div class="mt-6 flex space-x-4">
                <button id="resetBtn" class="w-full py-2 px-4 rounded-lg text-gray-700 bg-gray-200 hover:bg-gray-300">Start Over</button>
                <button id="nextStepBtn" class="w-full py-2 px-4 rounded-lg text-white bg-indigo-500 hover:bg-indigo-600">Next Step</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- DOM Elements ---
        const modeSelection = document.getElementById('mode-selection');
        const inputView = document.getElementById('input-view');
        const calculationView = document.getElementById('calculation-view');
        
        const learnModeBtn = document.getElementById('learnModeBtn');
        const practiceModeBtn = document.getElementById('practiceModeBtn');
        const backToModesBtn = document.getElementById('backToModesBtn');

        const inputTitle = document.getElementById('input-title');
        const number1Input = document.getElementById('number1');
        const number2Input = document.getElementById('number2');
        const inputError = document.getElementById('input-error');
        const startBtn = document.getElementById('startBtn');
        
        const calculationArea = document.getElementById('calculation-area');
        const highlightBox = document.getElementById('highlight-box');
        const hProblemText = document.getElementById('h-problem-text');
        const hProblemAnswer = document.getElementById('h-problem-answer');
        const num1Row = document.getElementById('num1-row');
        const num2Row = document.getElementById('num2-row');
        const resultRow = document.getElementById('result-row');
        
        const explanationBox = document.getElementById('explanation-box');
        const explanation = document.getElementById('explanation');
        const feedbackBox = document.getElementById('feedback-box');
        const feedbackText = document.getElementById('feedback-text');
        
        const nextStepBtn = document.getElementById('nextStepBtn');
        const resetBtn = document.getElementById('resetBtn');

        // --- State Variables ---
        let currentMode = '';
        let steps = [];
        let currentStep = 0;
        let correctAnswer = '';
        let isAudioReady = false;
        let practiceCalculations = [];

        // --- Audio Setup ---
        let celebrationSound, wrongSound;
        function setupAudio() {
            celebrationSound = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "sine" } }).toDestination();
            celebrationSound.volume.value = -6;
            wrongSound = new Tone.Synth({ oscillator: { type: 'square' }, envelope: { attack: 0.005, decay: 0.2, sustain: 0, release: 0.2 } }).toDestination();
            wrongSound.volume.value = -12;
        }
        async function startAudio() {
            if (!isAudioReady && Tone.context.state !== 'running') {
                await Tone.start();
                setupAudio();
                isAudioReady = true;
            }
        }

        // --- Utility Functions ---
        function formatNumbers(n1, n2) {
            let [int1, dec1 = ''] = String(n1).split('.');
            let [int2, dec2 = ''] = String(n2).split('.');
            const maxDec = Math.max(dec1.length, dec2.length);
            dec1 = dec1.padEnd(maxDec, '0');
            dec2 = dec2.padEnd(maxDec, '0');
            const maxInt = Math.max(int1.length, int2.length);
            int1 = int1.padStart(maxInt, ' ');
            int2 = int2.padStart(maxInt, ' ');
            const num1Str = maxDec > 0 ? `${int1}.${dec1}` : int1;
            const num2Str = maxDec > 0 ? `${int2}.${dec2}` : int2;
            return { num1Str, num2Str };
        }

        function fireConfetti() {
            confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });
        }

        // --- View Navigation ---
        function showView(viewId) {
            [modeSelection, inputView, calculationView].forEach(v => v.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
        }
        
        learnModeBtn.addEventListener('click', () => { 
            startAudio();
            currentMode = 'learn'; 
            inputTitle.textContent = 'Learn Subtraction'; 
            showView('input-view'); 
        });
        practiceModeBtn.addEventListener('click', () => { 
            startAudio();
            currentMode = 'practice'; 
            inputTitle.textContent = 'Practice Subtraction'; 
            showView('input-view'); 
        });
        backToModesBtn.addEventListener('click', () => showView('mode-selection'));
        resetBtn.addEventListener('click', () => showView('mode-selection'));

        // --- Calculation Logic ---
        startBtn.addEventListener('click', () => {
            const val1 = number1Input.value;
            const val2 = number2Input.value;

            if (val1.trim() === '' || val2.trim() === '') {
                inputError.textContent = 'Please enter numbers in both fields.'; return;
            }
            const num1 = parseFloat(val1);
            const num2 = parseFloat(val2);
            if (isNaN(num1) || isNaN(num2)) {
                inputError.textContent = 'Please enter valid numbers.'; return;
            }
            if (num1 < num2) {
                inputError.textContent = 'The first number must be larger than the second.'; return;
            }
            
            inputError.textContent = '';
            
            if (currentMode === 'learn') {
                startLearnMode();
            } else {
                startPracticeMode();
            }
        });

        // --- Learn Mode ---
        function startLearnMode() {
            showView('calculation-view');
            explanationBox.classList.remove('hidden');
            feedbackBox.classList.add('hidden');
            nextStepBtn.classList.remove('hidden');
            
            const n1 = number1Input.value.trim();
            const n2 = number2Input.value.trim();
            
            steps = generateSubtractionSteps(n1, n2);
            
            hProblemText.textContent = `${n1} - ${n2} = `;
            hProblemAnswer.textContent = '';
            
            currentStep = 0;
            displayStep(currentStep);
        }

        function displayStep(stepIndex) {
            if (!steps || steps.length === 0) return;
            const step = steps[stepIndex];
            explanation.textContent = step.explanation;

            [num1Row, num2Row, resultRow].forEach(el => el.innerHTML = '');
            highlightBox.classList.add('hidden');

            renderStandardProblem(step);
            
            if (stepIndex >= steps.length - 1) {
                nextStepBtn.disabled = true;
                nextStepBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                hProblemAnswer.textContent = step.finalAnswer || '';
            } else {
                nextStepBtn.disabled = false;
                nextStepBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
            }
        }
        
        nextStepBtn.addEventListener('click', () => {
            if (currentStep < steps.length - 1) {
                currentStep++;
                displayStep(currentStep);
            }
        });

        // --- Step Generation ---
        function generateSubtractionSteps(n1, n2) {
            let {num1Str, num2Str} = formatNumbers(n1, n2);
            const steps = [];
            let num1Arr = num1Str.split('');
            let resultArr = Array(num1Str.length).fill(' ');

            steps.push({ explanation: "First, line up the numbers by their decimal points.", col: -1, result: resultArr.join(''), num1: num1Arr.join(''), num2: `- ${num2Str}` });

            for (let i = num1Str.length - 1; i >= 0; i--) {
                if (num1Str[i] === '.') {
                    resultArr[i] = '.';
                    steps.push({ explanation: "Bring the decimal point straight down.", col: i, result: resultArr.join(''), num1: num1Arr.join(''), num2: `- ${num2Str}` });
                    continue;
                }
                if (num1Str[i].trim() === '' && num2Str[i].trim() === '') continue;

                let topDigit = parseInt(num1Arr[i]) || 0;
                let bottomDigit = parseInt(num2Str[i]) || 0;
                
                if (topDigit < bottomDigit) {
                    let expl = `In this column, we can't subtract ${bottomDigit} from ${topDigit}. We need to borrow.`;
                    steps.push({ explanation: expl, col: i, result: resultArr.join(''), num1: num1Arr.join(''), num2: `- ${num2Str}` });

                    let borrowFromIndex = i - 1;
                    let borrowChain = {};

                    // Find the first non-zero digit to borrow from
                    while (borrowFromIndex >= 0) {
                        if (num1Arr[borrowFromIndex] === '.') {
                            borrowFromIndex--;
                            continue;
                        }
                        borrowChain[borrowFromIndex] = { original: num1Arr[borrowFromIndex] };
                        if (parseInt(num1Arr[borrowFromIndex]) > 0) {
                            num1Arr[borrowFromIndex] = (parseInt(num1Arr[borrowFromIndex]) - 1).toString();
                            borrowChain[borrowFromIndex].new = num1Arr[borrowFromIndex];
                            break;
                        } else {
                            num1Arr[borrowFromIndex] = '9';
                             borrowChain[borrowFromIndex].new = '9';
                            borrowFromIndex--;
                        }
                    }
                    
                    const originalTopDigit = topDigit;
                    topDigit += 10;
                    
                    expl = `We borrow from the left. The ${originalTopDigit} becomes ${topDigit}.`;
                    steps.push({ explanation: expl, col: i, result: resultArr.join(''), num1: num1Arr.join(''), num2: `- ${num2Str}`, borrowVisual: { chain: borrowChain, to: { index: i, original: originalTopDigit } } });
                }
                
                const diff = topDigit - bottomDigit;
                resultArr[i] = diff.toString();
                steps.push({ explanation: `Now, subtract: ${topDigit} - ${bottomDigit} = ${diff}. Write down the ${diff}.`, col: i, result: resultArr.join(''), num1: num1Arr.join(''), num2: `- ${num2Str}` });
            }

            const finalAnswer = (parseFloat(n1) - parseFloat(n2)).toPrecision(15).replace(/\.?0+$/, "");
            steps.push({ explanation: `The final answer is ${finalAnswer}.`, col: -1, result: finalAnswer, num1: num1Arr.join(''), num2: `- ${num2Str}`, finalAnswer });
            return steps;
        }
        
        function generateSubtractionPracticeData(n1, n2) {
            let { num1Str, num2Str } = formatNumbers(n1, n2);
            const practiceData = [];
            let num1Arr = num1Str.split('');

            for (let i = num1Str.length - 1; i >= 0; i--) {
                if (num1Str[i] === '.' || (num1Str[i].trim() === '' && num2Str[i].trim() === '')) continue;

                let topDigit = parseInt(num1Arr[i]) || 0;
                let bottomDigit = parseInt(num2Str[i]) || 0;
                
                if (topDigit < bottomDigit) {
                    let borrowFromIndex = i - 1;
                    while (borrowFromIndex >= 0) {
                        if (num1Arr[borrowFromIndex] === '.') { borrowFromIndex--; continue; }
                        if (parseInt(num1Arr[borrowFromIndex]) > 0) {
                            num1Arr[borrowFromIndex] = (parseInt(num1Arr[borrowFromIndex]) - 1).toString();
                            break;
                        } else {
                            num1Arr[borrowFromIndex] = '9';
                            borrowFromIndex--;
                        }
                    }
                    topDigit += 10;
                }
                
                const diff = topDigit - bottomDigit;
                practiceData.unshift({ topDigit, bottomDigit, resultDigit: diff });
            }
            return practiceData;
        }

        // --- Practice Mode ---
        function startPracticeMode() {
            showView('calculation-view');
            explanationBox.classList.add('hidden');
            feedbackBox.classList.remove('hidden');
            nextStepBtn.classList.add('hidden');

            const n1 = number1Input.value.trim();
            const n2 = number2Input.value.trim();
            hProblemText.textContent = `${n1} - ${n2} = `;
            hProblemAnswer.textContent = '';
            
            correctAnswer = (parseFloat(n1) - parseFloat(n2)).toPrecision(15).replace(/\.?0+$/, "");
            practiceCalculations = generateSubtractionPracticeData(n1, n2);

            const { num1Str, num2Str } = formatNumbers(n1, n2);
            const maxLength = Math.max(num1Str.length, num2Str.length + 2, correctAnswer.length);
            
            const createCell = (content) => {
                const cell = document.createElement('span');
                cell.className = 'calc-cell';
                cell.innerHTML = content === ' ' ? '&nbsp;' : content;
                return cell;
            };

            const renderTextRow = (container, text) => {
                container.innerHTML = '';
                text.padStart(maxLength, ' ').split('').forEach(char => container.append(createCell(char)));
            };

            renderTextRow(num1Row, num1Str);
            renderTextRow(num2Row, `- ${num2Str}`);
            
            feedbackBox.className = 'mt-4 p-3 rounded-lg text-center h-20 flex items-center justify-center transition-all duration-300 chalkboard-font text-3xl bg-blue-100 border border-blue-300';
            feedbackText.textContent = 'Type the answer in the boxes, starting from the right!';
            
            resultRow.innerHTML = '';
            const resultInputs = [];
            
            correctAnswer.padStart(maxLength, ' ').split('').forEach(char => {
                if (char === ' ' || char === '.') {
                    resultRow.append(createCell(char));
                } else {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.maxLength = 1;
                    input.className = 'practice-input calc-cell';
                    resultRow.append(input);
                    resultInputs.push(input);
                }
            });

            let calcIndex = practiceCalculations.length - 1;
            resultInputs.slice().reverse().forEach((input) => {
                input.dataset.calcIndex = calcIndex;
                input.addEventListener('input', () => handleSubtractionPracticeInput(input, resultInputs));
                calcIndex--;
            });
            
            if (resultInputs.length > 0) {
                resultInputs[resultInputs.length - 1].focus();
            }
        }

        function handleSubtractionPracticeInput(input, allInputs) {
            const calcIndex = parseInt(input.dataset.calcIndex);
            const calcData = practiceCalculations[calcIndex];
            const correctValue = String(calcData.resultDigit);
            const currentIndex = allInputs.slice().reverse().indexOf(input);

            if (input.value === correctValue) {
                input.className = 'practice-input calc-cell input-correct';
                input.disabled = true;
                
                feedbackText.textContent = `Correct! ${input.value} is right.`;
                feedbackBox.className = 'mt-4 p-3 rounded-lg text-center h-20 flex items-center justify-center transition-all duration-300 chalkboard-font text-3xl bg-green-100 border-green-500 text-green-800';
                
                const nextInput = allInputs.slice().reverse()[currentIndex + 1];
                if (nextInput) {
                    nextInput.focus();
                } else {
                    feedbackText.textContent = 'ðŸŽ‰ Great Job! You solved it! ðŸŽ‰';
                    hProblemAnswer.textContent = correctAnswer;
                    if (isAudioReady) celebrationSound.triggerAttackRelease(["C4", "E4", "G4", "C5"], "8n");
                    fireConfetti();
                }
            } else if (input.value !== '') {
                if (isAudioReady) wrongSound.triggerAttackRelease("A2", "8n");
                input.className = 'practice-input calc-cell input-incorrect';
                let feedback = `Not quite. In that column, the calculation is ${calcData.topDigit} - ${calcData.bottomDigit}. Try again!`;
                feedbackText.textContent = feedback;
                feedbackBox.className = 'mt-4 p-3 rounded-lg text-center h-20 flex items-center justify-center transition-all duration-300 chalkboard-font text-3xl bg-red-100 border-red-500 text-red-800';
            }
        }

        // --- Rendering ---
        function renderStandardProblem(step) {
            const { num1Str, num2Str } = formatNumbers(number1Input.value, number2Input.value);
            const finalAnswer = (parseFloat(number1Input.value) - parseFloat(number2Input.value)).toString();
            const maxLength = Math.max(step.num1.length, step.num2.length, finalAnswer.length);

            const renderRow = (container, text, isTopRow = false) => {
                container.innerHTML = '';
                text.padStart(maxLength, ' ').split('').forEach((char, index) => {
                    const cell = document.createElement('span');
                    cell.className = 'calc-cell';
                    
                    if (isTopRow && step.borrowVisual) {
                        const borrowChain = step.borrowVisual.chain;
                        const borrowTo = step.borrowVisual.to;
                        
                        if (borrowChain[index]) {
                             const originalDigit = document.createElement('span');
                             originalDigit.className = 'borrow-digit';
                             originalDigit.textContent = borrowChain[index].original;
                             cell.appendChild(originalDigit);

                             const newDigit = document.createElement('span');
                             newDigit.className = 'borrow-new-digit';
                             newDigit.textContent = borrowChain[index].new;
                             cell.appendChild(newDigit);
                        } else if (borrowTo && borrowTo.index === index) {
                             const prependedOne = document.createElement('span');
                             prependedOne.className = 'borrow-one';
                             prependedOne.textContent = '1';
                             cell.appendChild(prependedOne);
                             cell.append(borrowTo.original);
                        }
                        else {
                           cell.innerHTML = char === ' ' ? '&nbsp;' : char;
                        }

                    } else {
                       cell.innerHTML = char === ' ' ? '&nbsp;' : char;
                    }
                    container.append(cell);
                });
            };

            renderRow(num1Row, step.num1, true);
            renderRow(num2Row, step.num2);
            renderRow(resultRow, step.result);
            
            const num1Padding = maxLength - step.num1.length;
            const highlightColIndex = step.col === -1 ? -1 : step.col + num1Padding;
            if (highlightColIndex !== -1) {
                const targetCell = num1Row.children[highlightColIndex];
                if (targetCell) {
                    highlightBox.style.left = `${targetCell.offsetLeft}px`;
                    highlightBox.style.top = `${num1Row.offsetTop}px`;
                    highlightBox.style.width = `${targetCell.offsetWidth}px`;
                    highlightBox.style.height = `${resultRow.offsetTop + resultRow.offsetHeight - num1Row.offsetTop}px`;
                    highlightBox.classList.remove('hidden');
                }
            } else {
                highlightBox.classList.add('hidden');
            }
        }
        
        showView('mode-selection');
    });
    </script>
</body>
</html>
